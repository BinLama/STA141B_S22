<!DOCTYPE html>
<html>
  <head>
    <title>Relational Databases 3</title>
    <meta charset="utf-8">
    <style>
      @import url(https://fonts.googleapis.com/css?family=Yanone+Kaffeesatz);
      @import url(https://fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic);
      @import url(https://fonts.googleapis.com/css?family=Ubuntu+Mono:400,700,400italic);

      body { font-family: 'Droid Serif'; }
      h1, h2, h3 {
        font-family: 'Yanone Kaffeesatz';
        font-weight: normal;
      }
      .remark-code, .remark-inline-code { font-family: 'Ubuntu Mono'; }
    </style>
  </head>
  <body>
    <textarea id="source">

class: center, middle

# Relational Databases - 3


### Duncan Temple Lang

<div style="clear: both"/>

<!-- <hr width="50%"/> -->

---
# Order of Evaluation of SQL Query

+ Understanding how the different elements of a query are evaluated helps to reason and debug

+ Consider the stackexchange data

```sql
SELECT  PostTypeId, value, COUNT(PostTypeId) 
 FROM Posts AS p, PostTypeIdMap AS m  
 WHERE PostTypeId = m.Id 
   AND value IN ('Question', 'Answer')
 GROUP BY PostTypeId 
```



---
# Evaluation Order


+ FROM or JOIN 

+ WHERE - selects the rows to be operated on.
   + executed before both the aggregate functions and the SELECT statement.

+ GROUP BY
   + any grouping levels eliminated by the WHERE will not appear as groups.

+ HAVING evaluated after the aggregation functions

+ SELECT - creates a new table with columns specified and the rows produced by the clauses before

+ DISTINCT - after SELECT has created a new table

+ ORDER BY 

+ LIMIT 

---
# What about Nested Queries?

+ They are evaluated according to the same order as above.

+ Whatever step in which the nested query occurs




---
# Reasoning about JOINs

+ Two tables <!-- - A and B -->
+ Compatible columns in each x and y

```sql
select * FROM fang_info;

AMZN|AMAZON COM INC|5961|2371000000.0
GOOGLE|ALPHABET INC.|7370|19478000000.0
FB|FACEBOOK INC|7370|10188000000.0
NFLX|NETFLIX INC|7841|186678000.0
```

```sql
select * FROM fang_sic;

3292|Abestos Products
5182|Wine and Distilled Alcoholic Beverages
5961|Catalog and Mail-Order Houses
7841|Video Tape Rental
```

---
# TIMES/Cartesian Product/CROSS JOIN

+ Consider all possible pairs of tuples between the two tables

```sql
SELECT * FROM fang_info CROSS JOIN fang_sic;

AMZN|AMAZON COM INC|5961|2371000000.0|3292|Abestos Products
AMZN|AMAZON COM INC|5961|2371000000.0|5182|Wine and Distilled Alcoholic Beverages
AMZN|AMAZON COM INC|5961|2371000000.0|5961|Catalog and Mail-Order Houses
AMZN|AMAZON COM INC|5961|2371000000.0|7841|Video Tape Rental
GOOGLE|ALPHABET INC.|7370|19478000000.0|3292|Abestos Products
GOOGLE|ALPHABET INC.|7370|19478000000.0|5182|Wine and Distilled Alcoholic Beverages
GOOGLE|ALPHABET INC.|7370|19478000000.0|5961|Catalog and Mail-Order Houses
GOOGLE|ALPHABET INC.|7370|19478000000.0|7841|Video Tape Rental
FB|FACEBOOK INC|7370|10188000000.0|3292|Abestos Products
FB|FACEBOOK INC|7370|10188000000.0|5182|Wine and Distilled Alcoholic Beverages
FB|FACEBOOK INC|7370|10188000000.0|5961|Catalog and Mail-Order Houses
FB|FACEBOOK INC|7370|10188000000.0|7841|Video Tape Rental
NFLX|NETFLIX INC|7841|186678000.0|3292|Abestos Products
NFLX|NETFLIX INC|7841|186678000.0|5182|Wine and Distilled Alcoholic Beverages
NFLX|NETFLIX INC|7841|186678000.0|5961|Catalog and Mail-Order Houses
NFLX|NETFLIX INC|7841|186678000.0|7841|Video Tape Rental
```

---
# WHERE 

+ INNER JOIN
+ Keep only the rows where sic_code = sic


<pre>
AMZN|AMAZON COM INC|5961|2371000000.0|3292|Abestos Products
AMZN|AMAZON COM INC|5961|2371000000.0|5182|Wine and Distilled Alcoholic Beverages
<a style="color:red">AMZN|AMAZON COM INC|5961|2371000000.0|5961|Catalog and Mail-Order Houses</a>
AMZN|AMAZON COM INC|5961|2371000000.0|7841|Video Tape Rental
GOOGLE|ALPHABET INC.|7370|19478000000.0|3292|Abestos Products
GOOGLE|ALPHABET INC.|7370|19478000000.0|5182|Wine and Distilled Alcoholic Beverages
GOOGLE|ALPHABET INC.|7370|19478000000.0|5961|Catalog and Mail-Order Houses
GOOGLE|ALPHABET INC.|7370|19478000000.0|7841|Video Tape Rental
FB|FACEBOOK INC|7370|10188000000.0|3292|Abestos Products
FB|FACEBOOK INC|7370|10188000000.0|5182|Wine and Distilled Alcoholic Beverages
FB|FACEBOOK INC|7370|10188000000.0|5961|Catalog and Mail-Order Houses
FB|FACEBOOK INC|7370|10188000000.0|7841|Video Tape Rental
NFLX|NETFLIX INC|7841|186678000.0|3292|Abestos Products
NFLX|NETFLIX INC|7841|186678000.0|5182|Wine and Distilled Alcoholic Beverages
NFLX|NETFLIX INC|7841|186678000.0|5961|Catalog and Mail-Order Houses
<a style="color:red">NFLX|NETFLIX INC|7841|186678000.0|7841|Video Tape Rental</a>
</pre>



---
# LEFT JOIN

+ Same as INNER JOIN
   + THEN
+ Append the tuples that had no match with the second/right table
  

---
# Stackexchange Data

+ 8 data tables

  + *Posts*
  + *Users*
  + *TagPosts*
  + Comments
  + Badges
  + PostHistory
  + Votes
  + PostLinks

+ 7 "map" tables
   + id and label

---
# Posts

+ Each tuple corresponds to a post
   + Question
   + Answer

   + Not comments made about a post


+ Posts table colums
<pre style="color:black"><code style="color:blue">Id                             
PostTypeId      
ParentId        
CreationDate    
AcceptedAnswerId
Body
OwnerUserId
Tags</code><code style="color:black">
Score
ViewCount
Title
...
ClosedDate
OwnerDisplayName</code></pre>


---

+ PostTypeId indicates whether a post is a question, answer, etc.

+ ParentId only non-zero for answer posts
   + Id value of question


---
# Table of First 2 questions

<pre style="font-size:15px">
      Id PostTypeId ParentId            CreationDate AcceptedAnswerId OwnerUserId                                  Tags
1      1          1          2010-07-19T19:12:12.510               15           8        <bayesian><prior><elicitation>
2      2          1          2010-07-19T19:12:57.157               59          24 <distributions><normality-assumption>
<a style="color:blue">3     15          2        1 2010-07-19T19:19:46.160                0           6                                      </a>
4     20          2        2 2010-07-19T19:24:35.803                0          37                                      
5     59          2        2 2010-07-19T19:43:20.423                0          39                                      
<a style="color:blue">6     98          2        1 2010-07-19T20:23:57.330                0          39                
7    154          2        1 2010-07-19T22:40:47.947                0         108                                      
8    218          2        1 2010-07-20T05:13:21.963                0         187                                                            </a>
9    357          2        2 2010-07-20T23:07:48.713                0        3807                                      
<a style="color:blue">10  2696          2        1 2010-09-15T21:08:26.077                0         319                                      </a>
11  9414          2        2 2011-04-10T14:30:50.133                0        3911                                      
12 11969          2        2 2011-06-16T06:25:08.077                0        5025                                      
13 17397          2        2 2011-10-21T20:16:03.847                0         686                                      
14 33936          2        2 2012-08-08T17:27:51.737                0       11887                                      
</pre>

+ First two rows in this subset are questions
   + others are anwsers

+ Question may have AcceptedAnswerId  - 15, 59
  + empty if no accepted answer

+ ParentId in answer posts
   + Blue tuples correspond to question 1
   + Black tuples correspond to question 2
---
# Tags

+ Only on questions, not answers
    
```
<bayesian><prior><elicitation>
<distributions><normality-assumption>
```

+ Not very convenient to work with
    
+  TagPosts table
    + Separate tuple for each tag value and corresponding post Id
<pre>
 Id                     Tags
  1                 bayesian
  1                    prior
  1              elicitation
  2            distributions
  2     normality-assumption
  3                 software
  3              open-source
  4            distributions
</pre>
    

---
# Users

```
  Id  DisplayName                   Location            CreationDate Reputation
1 -1    Community         on the server farm 2010-07-19T06:55:26.860          1
2  2 Geoff Dalgas              Corvallis, OR 2010-07-19T14:01:36.697        101
3  3 Jarrod Dixon Raleigh, NC, United States 2010-07-19T15:34:50.507        101
4  4       Emmett          San Francisco, CA 2010-07-19T19:03:27.400        101
5  5        Shane               New York, NY 2010-07-19T19:03:57.227      11663
```

+ And other columns

---
# Question

+ How many posts are there?

```
SELECT COUNT(*) FROM Posts;
```

---
# How many questions are there? answers?

<!-- Q8 & 9 -->

+ Can do these separately.
   + Or together
+ Can peek at the PostTypeIdMap to manually determine PostTypeId for question and answer.
   + Better  to explicitly join

```sql
SELECT COUNT(*)
FROM Posts, PostTypeIdMap
WHERE PostTypeId = PostTypeIdMap.id
  AND PostTypeIdMap.value = 'Question';
```

---
# Compute the number of Questions and Answers in one Query
```sql     
SELECT  PostTypeId, value, COUNT(PostTypeId) 
 FROM Posts AS p, PostTypeIdMap AS m  
 WHERE PostTypeId = m.Id 
 GROUP BY PostTypeId 
 HAVING value IN ('Question', 'Answer')
```

+ Avoid counting the non-Question and non-Answer values
   +   use WHERE to only count the Question and Answer
   +  not present when get to the GROUP BY
```sql
SELECT  PostTypeId, value, COUNT(PostTypeId) 
 FROM Posts AS p, PostTypeIdMap AS m  
 WHERE PostTypeId = m.Id
 AND value IN ('Question', 'Answer')
 GROUP BY PostTypeId 
````

---
# How many questions have an accepted answer?

```sql
SELECT COUNT(*) FROM Posts WHERE NOT AcceptedAnswerId ;
```
<!-- Q38
   -->

---
#  How many answers did each post receive?

```sql
SELECT p.Id, COUNT(p.Id) 
FROM Posts AS p, Posts AS p2
WHERE p2.ParentId = p.Id 
GROUP BY p.Id
```  

+ Note the self JOIN
   + Posts with Posts
   + Get each question tuple with each of its answer tuples


    </textarea>
    <script src="https://remarkjs.com/downloads/remark-latest.min.js">
    </script>
    <script src="remark-toc/index.js">     </script>   
    <script>
     var slideshow = remark.create();
//     var toc = require('remark-toc');
//     slideshow.use(toc);
    </script>
  </body>
</html>

