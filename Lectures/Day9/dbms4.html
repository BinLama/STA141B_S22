<!DOCTYPE html>
<html>
  <head>
    <title>Relational Databases 4</title>
    <meta charset="utf-8">
    <style>
      @import url(https://fonts.googleapis.com/css?family=Yanone+Kaffeesatz);
      @import url(https://fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic);
      @import url(https://fonts.googleapis.com/css?family=Ubuntu+Mono:400,700,400italic);

      body { font-family: 'Droid Serif'; }
      h1, h2, h3 {
        font-family: 'Yanone Kaffeesatz';
        font-weight: normal;
      }
      .remark-code, .remark-inline-code { font-family: 'Ubuntu Mono'; }
    </style>
  </head>
  <body>
    <textarea id="source">

class: center, middle

# Relational Databases - 4



### Duncan Temple Lang

<div style="clear: both"/>

---
# Recap

+ Last question we answered
  +  How many answers did each post receive?

+ Can use [ai.stackexchange database](https://canvas.ucdavis.edu/files/10557753/download?download_frd=1)  on  Canvas.
  + only 11 Mb, 2111 posts.

--

+ Constructed new table for query
   + question post tuple with each answer post tuple
   + only where the question Id matched the answer Parent Id

+ Self-JOIN on Posts

+ Then `GROUP BY` question Id and do a COUNT().


---
# Question 1

<!-- Q12 parts 1 and 2. Do 2 first. -->
+ What is the length of time to receive an answer?
   +  time to getting an accepted answer?

+ How would we also include the name of the user who posted the accepted answer.


---
# Approach

+ Start with finding the time to the accepted answer
  + Easier.

+ For each question
   + Get the accepted answer tuple for that question
   + Subtract question CreationDate from answer CreationDate

+ Need to turn CreationDate  values into actual dates/numbers

+ Natural to think in loops
   + but not in SQL

---
# Create Table

+ Self-JOIN on Posts
   + question tuples
   + AcceptedAnswer tuples

<table>
    <tr>
	<th>Id</th><th>Type</th><th>AcceptedId</th><th>CreationDate</th><th>Id</th><th>Type</th><th>CreationDate</th>
    </tr>
    <tr>
	<td>1</td><td>1</td><td>15</td><td>2010-07-19T19:12:12</td><code style="color:green"><td>15</td><td>2</td><td>2010-07-19T19:19:46</td></code>
    </tr>
    <tr>
	<td>2</td><td>1</td><td>59</td><td>2010-07-19T19:12:57</td><td>59</td><td>2</td><td>2010-07-19T19:43:20</td>
    </tr>
</table>

+ Then take difference between two CreationDate variables.


---
# SQL

```sql
SELECT p1.Id, 
       (julianday(p2.CreationDate) - julianday(p1.CreationDate))*86400 AS diff,
       p2.CreationDate AS answer,
       p1.CreationDate AS question
FROM Posts AS p1, Posts AS p2
WHERE  
   p1.Id = p2.ParentId
  AND
   p1.PostTypeId = 1 AND p2.PostTypeId = 2
  AND
   p1.AcceptedAnswerId = p2.Id
```

+ What's the 86400 value we multiply the difference by?
   +  24*60*60 = number of seconds in a day. 

+ Do we **need** the PostTypeId tests?

---
# Time to get first answer
## Not the accepted one


```
    Id            CreationDate AcceptedAnswerId
    23 2010-07-19T19:26:04.363              189
    91 2010-07-19T20:15:54.823                0
   189 2010-07-20T00:59:34.643                0
437776 2019-11-25T02:55:06.540                0
```


<!--    Q12 part 1 -->

<!--
     Time to first answer.
   -->

```sql     
SELECT p1.Id, 
       (julianday(p2.CreationDate) - julianday(p1.CreationDate))*86400 AS diff,
       p2.CreationDate AS answer,
       p1.CreationDate AS question
FROM Posts AS p1, Posts AS p2
WHERE  
   p1.Id = p2.ParentId
  AND
   p1.PostTypeId = 1 AND p2.PostTypeId = 2 
GROUP BY p1.Id 
HAVING diff = MIN(diff);
```

Alternatively, we can compute the MIN() in each group
```
```sql     
SELECT p1.Id, 
       MIN((julianday(p2.CreationDate) - julianday(p1.CreationDate))*86400) AS diff,
FROM Posts AS p1, Posts AS p2
WHERE  
   p1.Id = p2.ParentId
  AND
   p1.PostTypeId = 1 AND p2.PostTypeId = 2 
GROUP BY p1.Id 
```


---
# HAVING clause

+ Often use HAVING on COUNT() which has aggregated the records in a sub-group to a single tuple

+ However, HAVING works row by row within each sub-group
  + COUNT() is a special case where only one tuple in each sub-group.

+ See [havingEg](https://canvas.ucdavis.edu/files/10557846/download?download_frd=1)


---
# Test Database

+ Create database with a table
```sql
CREATE TABLE Foo (
 g INTEGER,
 age  INTEGER
);
```

+ Populate with sample values
```sql
INSERT INTO Foo VALUES
(1, 20),
(1, 30),
(1, 10),
(2, 55),
(2, 27);
```

+ Test query
```sql
select * FROM Foo
GROUP BY g
HAVING age = MIN(age);
1|10
2|27
```

---
# Question 2

+ What's the length of each question?
+ How does the length of a question relate to the length of time to getting answers?

<!-- Q14 & 15

   -->

+ To get the length/number of characters in each question
```sql
SELECT length(Body)
FROM Posts
WHERE PostTypeId = 1;
```

+ Bring it back to R.
  + Combine with length of time until an answer.

+ Different number of rows in the two result sets
  + All questions have a body
  + Not all questions have an answer.

+ If they did have the same number, they might be in different order.
  + Could use ORDER BY Id

+ Instead use match() in R to explicitly connect the rows in one table to the other table.

+ But should combine the results in SQL.

---
# Key Concepts

+ Can't do two queries separately and expect the results to match.
  + Different number of results.
  + Need to match by some identifier.

+ Do the matching in SQL
  + or be careful when doing it in R, Python, ...





    </textarea>
    <script src="https://remarkjs.com/downloads/remark-latest.min.js">
    </script>
    <script src="remark-toc/index.js">     </script>   
    <script>
     var slideshow = remark.create();
//     var toc = require('remark-toc');
//     slideshow.use(toc);
    </script>
  </body>
</html>

